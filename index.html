<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIX SEC OPS</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    [data-theme="dark"] {
      background: #222;
      color: #fff;
    }
    [data-theme="dark"] button, [data-theme="dark"] select {
      background: #444;
      color: #fff;
    }
    .tabs {
      margin: 20px 0;
    }
    .tab {
      padding: 10px;
      margin-right: 5px;
      cursor: pointer;
    }
    .tab.active {
      background: #007bff;
      color: #fff;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #f2f2f2;
    }
    [data-theme="dark"] th {
      background: #555;
    }
    .status-green { color: green; }
    .status-orange { color: orange; }
    .status-red { color: red; }
    .flight-logo { width: 20px; vertical-align: middle; }
    #followed-flights {
      margin-top: 20px;
    }
    #followed-flights ul {
      list-style: none;
      padding: 0;
    }
    #followed-flights li {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>AIX SEC OPS</h1>
    <button id="themeToggle">Dark Mode</button>
  </header>

  <div>
    <label for="airportSelect">Airport: </label>
    <select id="airportSelect">
      <option value="COK">Cochin (COK)</option>
      <option value="CCJ">Calicut (CCJ)</option>
      <option value="CNN">Kannur (CNN)</option>
      <option value="TRV">Trivandrum (TRV)</option>
    </select>
    <label for="timeRangeSelect">Time Range: </label>
    <select id="timeRangeSelect">
      <option value="8">8 Hours Ahead</option>
      <option value="12">12 Hours Ahead</option>
      <option value="24">24 Hours Ahead</option>
      <option value="48">48 Hours Ahead</option>
    </select>
    <button id="refreshButton">Refresh Data</button>
    <button id="pastHourButton">Show Past 1 Hour</button>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="arrivals">Arrivals</button>
    <button class="tab" data-tab="departures">Departures</button>
    <button class="tab" data-tab="turnaround">Turnaround</button>
  </div>

  <div id="arrivals" class="tab-content active">
    <div>
      <label for="arrivalsAirlineFilter">Airline Filter</label>
      <select id="arrivalsAirlineFilter">
        <option value="all">All</option>
        <option value="IX">IX Only</option>
        <option value="IXAI">IX + AI</option>
      </select>
      <label for="arrivalsSortOption">Sort By</label>
      <select id="arrivalsSortOption">
        <option value="estimated">ETA</option>
        <option value="scheduled">STA</option>
      </select>
    </div>
    <table id="arrivals-table">
      <thead>
        <tr>
          <th>Flight</th>
          <th>Registration</th>
          <th>From</th>
          <th>ETA</th>
          <th>STA</th>
          <th>Aircraft</th>
          <th>Status</th>
          <th>Follow</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="8">Loading arrivals data...</td></tr>
      </tbody>
    </table>
  </div>

  <div id="departures" class="tab-content">
    <div>
      <label for="departuresAirlineFilter">Airline Filter</label>
      <select id="departuresAirlineFilter">
        <option value="all">All</option>
        <option value="IX">IX Only</option>
        <option value="IXAI">IX + AI</option>
      </select>
      <label for="departuresSortOption">Sort By</label>
      <select id="departuresSortOption">
        <option value="estimated">ETD</option>
        <option value="scheduled">STD</option>
      </select>
    </div>
    <table id="departures-table">
      <thead>
        <tr>
          <th>Flight</th>
          <th>Registration</th>
          <th>To</th>
          <th>ETD</th>
          <th>STD</th>
          <th>Aircraft</th>
          <th>Status</th>
          <th>Follow</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="8">Loading departures data...</td></tr>
      </tbody>
    </table>
  </div>

  <div id="turnaround" class="tab-content">
    <div>
      <label for="turnaroundAirlineFilter">Airline Filter</label>
      <select id="turnaroundAirlineFilter">
        <option value="all">All</option>
        <option value="IX">IX Only</option>
        <option value="IXAI">IX + AI</option>
      </select>
      <label for="turnaroundSortOption">Sort By</label>
      <select id="turnaroundSortOption">
        <option value="estimated">ETA</option>
        <option value="scheduled">STA</option>
      </select>
    </div>
    <table id="turnaround-table">
      <thead>
        <tr>
          <th>Arrival</th>
          <th>Registration</th>
          <th>Departure</th>
          <th>STA/STD</th>
          <th>Sector</th>
          <th>Aircraft</th>
          <th>Status</th>
          <th>Follow</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="8">Loading turnaround data...</td></tr>
      </tbody>
    </table>
  </div>

  <div id="followed-flights">
    <h2>Followed Flights</h2>
    <ul id="followed-flights-list"></ul>
  </div>

  <script>
    const getBaseUrl = () => {
      const airportCode = document.getElementById("airportSelect").value || "cok";
      return `https://api.flightradar24.com/common/v1/airport.json?code=${airportCode.toLowerCase()}`;
    };

    const getEndpoint = (type) => {
      const timestamp = Math.floor(Date.now() / 1000);
      return `${getBaseUrl()}&plugin-setting[schedule][mode]=${type}&plugin-setting[schedule][timestamp]=${timestamp}&page=1&limit=100`;
    };

    const toLocalTime = (ts) =>
      ts ? new Date(ts * 1000).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", hour12: false }) : "-";

    const classifyStatus = (estimated, scheduled) => {
      if (!estimated || !scheduled) return "status-green";
      const delay = estimated - scheduled;
      if (delay <= 0) return "status-green";
      if (delay <= 900) return "status-orange";
      return "status-red";
    };

    const getLogoURL = (flightNumber) => {
      if (!flightNumber) return "";
      if (flightNumber.startsWith("IX")) {
        return "https://cdn.brandfetch.io/idM6IAvrlf/w/820/h/248/theme/dark/logo.png?c=1dxbfHSJFAPEGdCLU4o5B";
      } else if (flightNumber.startsWith("AI")) {
        return "https://cdn.brandfetch.io/id-PSmaCm4/w/800/h/284/theme/light/logo.png?c=1dxbfHSJFAPEGdCLU4o5B";
      } else if (flightNumber.startsWith("UL")) {
        return "https://cdn.brandfetch.io/idZQkqhbVi/w/800/h/578/theme/dark/symbol.png?c=1dxbfHSJFAPEGdCLU4o5B";
      } else if (flightNumber.startsWith("AK") || flightNumber.startsWith("FD")) {
        return "https://upload.wikimedia.org/wikipedia/commons/thumb/8/82/AirAsia_New_Logo_%282020%29.svg/768px-AirAsia_New_Logo_%282020%29.svg.png";
      } else if (flightNumber.startsWith("FZ")) {
        return "https://cdn.brandfetch.io/idzRsGDSFE/w/800/h/162/theme/dark/logo.png?c=1dxbfHSJFAPEGdCLU4o5B";
      } else if (flightNumber.startsWith("J9")) {
        return "https://cdn.brandfetch.io/idRWbgTyu0/w/800/h/248/theme/dark/logo.png?c=1dxbfHSJFAPEGdCLU4o5B";
      }
      return "";
    };

    const getFollowedFlights = () => {
      return JSON.parse(localStorage.getItem("followedFlights") || "[]");
    };

    const saveFollowedFlights = (flights) => {
      localStorage.setItem("followedFlights", JSON.stringify(flights));
    };

    const updateFollowedFlightsList = () => {
      const followedFlights = getFollowedFlights();
      const list = document.getElementById("followed-flights-list");
      list.innerHTML = "";
      if (followedFlights.length === 0) {
        list.innerHTML = "<li>No flights followed</li>";
        return;
      }
      followedFlights.forEach((flight) => {
        const li = document.createElement("li");
        li.textContent = `${flight.flightNumber} (${flight.type} at ${flight.airport}) - ${toLocalTime(flight.time)}`;
        const unfollowButton = document.createElement("button");
        unfollowButton.textContent = "Unfollow";
        unfollowButton.onclick = () => {
          const updatedFlights = getFollowedFlights().filter((f) => f.flightNumber !== flight.flightNumber || f.type !== flight.type || f.airport !== flight.airport);
          saveFollowedFlights(updatedFlights);
          updateFollowedFlightsList();
          refreshAllFlights();
        };
        li.appendChild(unfollowButton);
        list.appendChild(li);
      });
    };

    const filterAndSortFlights = (flights, type, airlineFilterId, sortOptionId, includePast = false) => {
      const filterValue = document.getElementById(airlineFilterId).value;
      const sortOption = document.getElementById(sortOptionId).value;
      const timeRange = parseInt(document.getElementById("timeRangeSelect").value) * 3600;
      const now = Math.floor(Date.now() / 1000);
      const pastHour = now - 3600;

      return flights.filter((f) => {
        const fn = f.flight?.identification?.number?.default || "";
        const airlineCode = fn.substring(0, 2);
        const est = type === "departures" ? f.flight.time.estimated?.departure : f.flight.time.estimated?.arrival;
        const sch = type === "departures" ? f.flight.time.scheduled?.departure : f.flight.time.scheduled?.arrival;
        const act = type === "departures" ? f.flight.time.actual?.departure : f.flight.time.actual?.arrival;

        const flightTime = est || sch;
        if (!flightTime) return false;

        const isWithinTimeRange = includePast
          ? flightTime >= pastHour && flightTime <= now + timeRange
          : flightTime >= now && flightTime <= now + timeRange;

        if (isWithinTimeRange) {
          if (filterValue === "IX") {
            return fn.startsWith("IX");
          } else if (filterValue === "IXAI") {
            return fn.startsWith("IX") || fn.startsWith("AI");
          } else {
            return fn.startsWith("IX") || ["AK", "FD", "UL", "FZ", "J9"].includes(airlineCode);
          }
        }
        return false;
      }).sort((a, b) => {
        const getTime = (f) =>
          sortOption === "estimated"
            ? (type === "departures" ? f.flight.time.estimated?.departure : f.flight.time.estimated?.arrival) || 0
            : (type === "departures" ? f.flight.time.scheduled?.departure : f.flight.time.scheduled?.arrival) || 0;
        return getTime(a) - getTime(b);
      });
    };

    const loadFlights = async (type, tableId, airlineFilterId, sortOptionId, includePast = false) => {
      const tbody = document.querySelector(`#${tableId} tbody`);
      tbody.innerHTML = "<tr><td colspan='8'>Loading...</td></tr>";

      try {
        const res = await fetch(getEndpoint(type));
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const data = await res.json();
        const flights = data.result?.response?.airport?.pluginData?.schedule?.[type]?.data || [];
        
        tbody.innerHTML = "";
        if (flights.length === 0) {
          tbody.innerHTML = "<tr><td colspan='8'>No flights available</td></tr>";
          return;
        }

        const filteredFlights = filterAndSortFlights(flights, type, airlineFilterId, sortOptionId, includePast);
        if (filteredFlights.length === 0) {
          tbody.innerHTML = "<tr><td colspan='8'>No flights match the selected filters</td></tr>";
          return;
        }

        const followedFlights = getFollowedFlights();
        const airportCode = document.getElementById("airportSelect").value || "COK";
        filteredFlights.forEach((f) => {
          const fl = f.flight;
          const isDep = type === "departures";
          const est = isDep ? fl.time.estimated?.departure : fl.time.estimated?.arrival;
          const sch = isDep ? fl.time.scheduled?.departure : fl.time.scheduled?.arrival;
          const fn = fl.identification.number?.default || "-";
          const logo = getLogoURL(fn);
          const reg = fl.aircraft?.registration || "-";
          const airport = isDep ? fl.airport.destination?.code?.iata : fl.airport.origin?.code?.iata || "-";
          const model = fl.aircraft?.model?.code || "-"; // Use concise model code
          const status = fl.status?.text || "-";
          const isFollowed = followedFlights.some(
            (f) => f.flightNumber === fn && f.type === type && f.airport === airportCode
          );

          const row = document.createElement("tr");
          row.innerHTML = `
            <td><img class="flight-logo" src="${logo}" alt="logo" style="width: 20px; vertical-align: middle;"> ${fn}</td>
            <td>${reg}</td>
            <td>${airport}</td>
            <td>${toLocalTime(est)}</td>
            <td>${toLocalTime(sch)}</td>
            <td>${model}</td>
            <td class="${classifyStatus(est, sch)}">${status}</td>
            <td><button class="follow-button" data-flight="${fn}" data-type="${type}" data-airport="${airportCode}">${isFollowed ? "Unfollow" : "Follow"}</button></td>
          `;
          tbody.appendChild(row);
        });

        // Add follow/unfollow event listeners
        document.querySelectorAll(`#${tableId} .follow-button`).forEach((button) => {
          button.addEventListener("click", () => {
            const flightNumber = button.dataset.flight;
            const flightType = button.dataset.type;
            const flightAirport = button.dataset.airport;
            const followedFlights = getFollowedFlights();
            const isFollowed = followedFlights.some(
              (f) => f.flightNumber === flightNumber && f.type === flightType && f.airport === flightAirport
            );

            if (isFollowed) {
              const updatedFlights = followedFlights.filter(
                (f) => f.flightNumber !== flightNumber || f.type !== flightType || f.airport !== flightAirport
              );
              saveFollowedFlights(updatedFlights);
              button.textContent = "Follow";
            } else {
              followedFlights.push({
                flightNumber,
                type: flightType,
                airport: flightAirport,
                time: est || sch
              });
              saveFollowedFlights(followedFlights);
              button.textContent = "Unfollow";
            }
            updateFollowedFlightsList();
          });
        });
      } catch (err) {
        console.error(`Error loading ${type}:`, err);
        tbody.innerHTML = `<tr><td colspan='8'>Error loading ${type} data</td></tr>`;
      }
    };

    const loadTurnaround = async () => {
      const tbody = document.querySelector("#turnaround-table tbody");
      tbody.innerHTML = "<tr><td colspan='8'>Loading...</td></tr>";

      try {
        const [arrRes, depRes] = await Promise.all([fetch(getEndpoint("arrivals")), fetch(getEndpoint("departures"))]);
        if (!arrRes.ok || !depRes.ok) throw new Error("Failed to fetch arrivals or departures");

        const arrData = await arrRes.json();
        const depData = await depRes.json();
        const arrivals = arrData.result?.response?.airport?.pluginData?.schedule?.arrivals?.data || [];
        const departures = depData.result?.response?.airport?.pluginData?.schedule?.departures?.data || [];

        tbody.innerHTML = "";
        if (arrivals.length === 0 || departures.length === 0) {
          tbody.innerHTML = "<tr><td colspan='8'>No turnaround flights available</td></tr>";
          return;
        }

        const timeRange = parseInt(document.getElementById("timeRangeSelect").value) * 3600;
        const now = Math.floor(Date.now() / 1000);
        const turnarounds = [];
        arrivals.forEach((arr) => {
          const arrFlight = arr.flight;
          const arrReg = arrFlight.aircraft?.registration;
          const arrTime = arrFlight.time.estimated?.arrival || arrFlight.time.scheduled?.arrival;
          if (!arrReg || !arrTime || arrTime > now + timeRange) return;

          const matchingDep = departures.find((dep) => {
            const depFlight = dep.flight;
            const depReg = depFlight.aircraft?.registration;
            const depTime = depFlight.time.estimated?.departure || depFlight.time.scheduled?.departure;
            return depReg === arrReg && depTime > arrTime && (depTime - arrTime) <= 2 * 3600 && depTime <= now + timeRange;
          });

          if (matchingDep) {
            turnarounds.push({ arrival: arrFlight, departure: matchingDep.flight });
          }
        });

        const filteredTurnarounds = filterAndSortFlights(
          turnarounds.map((t) => ({ flight: t.arrival })),
          "arrivals",
          "turnaroundAirlineFilter",
          "turnaroundSortOption"
        ).map((arr) => turnarounds.find((t) => t.arrival === arr.flight));

        if (filteredTurnarounds.length === 0) {
          tbody.innerHTML = "<tr><td colspan='8'>No turnaround flights match the selected filters</td></tr>";
          return;
        }

        const followedFlights = getFollowedFlights();
        const airportCode = document.getElementById("airportSelect").value || "COK";
        filteredTurnarounds.forEach((t) => {
          const arr = t.arrival;
          const dep = t.departure;
          const arrFn = arr.identification.number?.default || "-";
          const depFn = dep.identification.number?.default || "-";
          const logo = getLogoURL(arrFn);
          const reg = arr.aircraft?.registration || "-";
          const arrAirport = arr.airport.origin?.code?.iata || "-";
          const depAirport = dep.airport.destination?.code?.iata || "-";
          const sector = `${arrAirport} - ${airportCode} - ${depAirport}`;
          const model = arr.aircraft?.model?.code || "-"; // Use concise model code
          const arrStatus = arr.status?.text || "-";
          const arrEst = arr.time.estimated?.arrival;
          const arrSch = arr.time.scheduled?.arrival;
          const depSch = dep.time.scheduled?.departure;
          const isFollowed = followedFlights.some(
            (f) => f.flightNumber === arrFn && f.type === "turnaround" && f.airport === airportCode
          );

          const row = document.createElement("tr");
          row.innerHTML = `
            <td><img class="flight-logo" src="${logo}" alt="logo" style="width: 20px; vertical-align: middle;"> ${arrFn}</td>
            <td>${reg}</td>
            <td><img class="flight-logo" src="${getLogoURL(depFn)}" alt="logo" style="width: 20px; vertical-align: middle;"> ${depFn}</td>
            <td>${toLocalTime(arrSch)} / ${toLocalTime(depSch)}</td>
            <td>${sector}</td>
            <td>${model}</td>
            <td class="${classifyStatus(arrEst, arrSch)}">${arrStatus}</td>
            <td><button class="follow-button" data-flight="${arrFn}" data-type="turnaround" data-airport="${airportCode}">${isFollowed ? "Unfollow" : "Follow"}</button></td>
          `;
          tbody.appendChild(row);
        });

        // Add follow/unfollow event listeners for turnaround
        document.querySelectorAll("#turnaround-table .follow-button").forEach((button) => {
          button.addEventListener("click", () => {
            const flightNumber = button.dataset.flight;
            const flightType = button.dataset.type;
            const flightAirport = button.dataset.airport;
            const followedFlights = getFollowedFlights();
            const isFollowed = followedFlights.some(
              (f) => f.flightNumber === flightNumber && f.type === flightType && f.airport === flightAirport
            );

            if (isFollowed) {
              const updatedFlights = followedFlights.filter(
                (f) => f.flightNumber !== flightNumber || f.type !== flightType || f.airport !== flightAirport
              );
              saveFollowedFlights(updatedFlights);
              button.textContent = "Follow";
            } else {
              followedFlights.push({
                flightNumber,
                type: flightType,
                airport: flightAirport,
                time: arrEst || arrSch
              });
              saveFollowedFlights(followedFlights);
              button.textContent = "Unfollow";
            }
            updateFollowedFlightsList();
          });
        });
      } catch (err) {
        console.error("Error loading turnaround data:", err);
        tbody.innerHTML = "<tr><td colspan='8'>Error loading turnaround data</td></tr>";
      }
    };

    const refreshAllFlights = (includePast = false) => {
      loadFlights("arrivals", "arrivals-table", "arrivalsAirlineFilter", "arrivalsSortOption", includePast);
      loadFlights("departures", "departures-table", "departuresAirlineFilter", "departuresSortOption", includePast);
      loadTurnaround();
      updateFollowedFlightsList();
    };

    const themeToggle = document.getElementById("themeToggle");
    const setTheme = (theme) => {
      document.documentElement.setAttribute("data-theme", theme);
      themeToggle.textContent = theme === "dark" ? "Light Mode" : "Dark Mode";
      localStorage.setItem("theme", theme);
    };

    const initializeTheme = () => {
      const savedTheme = localStorage.getItem("theme") || "light";
      setTheme(savedTheme);
    };

    themeToggle.addEventListener("click", () => {
      const currentTheme = document.documentElement.getAttribute("data-theme") || "light";
      setTheme(currentTheme === "dark" ? "light" : "dark");
    });

    document.getElementById("airportSelect").addEventListener("change", () => refreshAllFlights());
    document.getElementById("timeRangeSelect").addEventListener("change", () => refreshAllFlights());
    document.getElementById("arrivalsAirlineFilter").addEventListener("change", () => loadFlights("arrivals", "arrivals-table", "arrivalsAirlineFilter", "arrivalsSortOption"));
    document.getElementById("arrivalsSortOption").addEventListener("change", () => loadFlights("arrivals", "arrivals-table", "arrivalsAirlineFilter", "arrivalsSortOption"));
    document.getElementById("departuresAirlineFilter").addEventListener("change", () => loadFlights("departures", "departures-table", "departuresAirlineFilter", "departuresSortOption"));
    document.getElementById("departuresSortOption").addEventListener("change", () => loadFlights("departures", "departures-table", "departuresAirlineFilter", "departuresSortOption"));
    document.getElementById("turnaroundAirlineFilter").addEventListener("change", loadTurnaround);
    document.getElementById("turnaroundSortOption").addEventListener("change", loadTurnaround);
    document.getElementById("refreshButton").addEventListener("click", () => refreshAllFlights());
    document.getElementById("pastHourButton").addEventListener("click", () => refreshAllFlights(true));

    document.querySelectorAll(".tab").forEach((tab) => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach((t) => t.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach((c) => c.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.tab).classList.add("active");
      });
    });

    initializeTheme();
    refreshAllFlights();
    setInterval(() => refreshAllFlights(), 30000);
  </script>
</body>
</html>
