<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AIX SEC OPS - Cochin Airport</title>
  <meta name="theme-color" content="#000000" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root {
      --bg-color: #ffffff;
      --text-color: #000000;
      --header-bg: #f0f0f0;
      --table-header-bg: #333333;
      --table-header-text: #ffffff;
      --border-color: #cccccc;
      --control-bg: #ffffff;
      --control-text: #000000;
      --delayed-row-bg: #fff0f0;
      --completed-row-bg: #f0fff0;
      --primary-color: #0066cc;
      --secondary-color: #e4f1fe;
      --highlight-color: #ffcc00;
    }

    [data-theme="dark"] {
      --bg-color: #1a1a1a;
      --text-color: #ffffff;
      --header-bg: #2a2a2a;
      --table-header-bg: #444444;
      --table-header-text: #ffffff;
      --border-color: #555555;
      --control-bg: #333333;
      --control-text: #ffffff;
      --delayed-row-bg: #3a2a2a;
      --completed-row-bg: #2a3a2a;
      --primary-color: #4d94ff;
      --secondary-color: #2a3a4a;
      --highlight-color: #cc9900;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: all 0.3s ease;
    }

    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px 20px;
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: var(--header-bg);
      padding: 10px 20px;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 20px;
    }

    .app-title {
      margin: 0;
      font-size: 1.5rem;
    }

    .tab-container {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 20px;
    }

    .tab {
      padding: 8px 16px;
      cursor: pointer;
      border: 1px solid var(--border-color);
      border-bottom: none;
      border-radius: 5px 5px 0 0;
      margin-right: 4px;
      background-color: var(--control-bg);
      color: var(--control-text);
    }

    .tab.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .control-group {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    select, button {
      padding: 8px 12px;
      background-color: var(--control-bg);
      color: var(--control-text);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
    }

    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
    }

    button:hover {
      opacity: 0.9;
    }

    .content-section {
      display: none;
    }

    .content-section.active {
      display: block;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 40px;
    }

    th, td {
      border: 1px solid var(--border-color);
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: var(--table-header-bg);
      color: var(--table-header-text);
      position: sticky;
      top: 0;
    }

    .status-green { color: green; font-weight: bold; }
    .status-orange { color: orange; font-weight: bold; }
    .status-red { color: red; font-weight: bold; }

    .delayed-row { 
      background-color: var(--delayed-row-bg); 
      border-left: 4px solid red;
      animation: highlight-pulse 2s infinite;
    }

    .completed-row { background-color: var(--completed-row-bg); }

    @keyframes highlight-pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 204, 0, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(255, 204, 0, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 204, 0, 0); }
    }

    .flight-logo {
      height: 20px;
      vertical-align: middle;
      margin-right: 5px;
    }

    .loading-indicator {
      text-align: center;
      padding: 20px;
      font-style: italic;
    }

    .install-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      background-color: var(--primary-color);
      color: white;
      padding: 10px 15px;
      border-radius: 50px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: none;
    }

    .last-updated {
      text-align: right;
      font-size: 0.8rem;
      margin-bottom: 10px;
      opacity: 0.7;
    }

    @media (max-width: 768px) {
      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      .control-group {
        justify-content: space-between;
      }

      th, td {
        padding: 6px;
        font-size: 0.9rem;
      }

      .flight-logo {
        height: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="app-header">
      <h1 class="app-title">AIX SEC OPS - Cochin Airport</h1>
      <button id="themeToggle">Toggle Dark Mode</button>
    </div>

    <div class="tab-container">
      <div class="tab active" data-tab="flights">Flights</div>
      <div class="tab" data-tab="weather">Weather & Runways</div>
    </div>

    <!-- Flights Section -->
    <div id="flights-section" class="content-section active">
      <div class="controls">
        <div class="control-group">
          <label>
            Airline Filter:
            <select id="airlineFilter">
              <option value="IX">AIX Only</option>
              <option value="IXAI">AIX + AI</option>
              <option value="IXOAL" selected>AIX + OAL</option>
            </select>
          </label>
          <label>
            Sort by:
            <select id="sortOption">
              <option value="scheduled" selected>STA / STD</option>
              <option value="estimated">ETA / ETD</option>
              <option value="delayed">Delayed First</option>
            </select>
          </label>
          <label>
            Time Window:
            <select id="timeWindow">
              <option value="6">6 Hours</option>
              <option value="12">12 Hours</option>
              <option value="20" selected>20 Hours</option>
              <option value="48">48 Hours</option>
            </select>
          </label>
        </div>
        <div class="control-group">
          <label>
            Flight Type:
            <select id="flightTypeFilter">
              <option value="all" selected>All</option>
              <option value="arrivals">Arrivals Only</option>
              <option value="departures">Departures Only</option>
            </select>
          </label>
          <button id="refreshButton">Refresh Data</button>
          <button id="loadEarlierBtn">Load Earlier Flights</button>
        </div>
      </div>

      <div class="last-updated" id="lastUpdated">Last updated: -</div>

      <div id="arrivals-container">
        <h2>Arrivals - AIX Security-COK</h2>
        <table id="arrivals-table">
          <thead>
            <tr>
              <th>Flight No</th>
              <th>Registration</th>
              <th>From</th>
              <th>ETA</th>
              <th>STA</th>
              <th>Aircraft</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="7" class="loading-indicator">Loading arrival data...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="departures-container">
        <h2>Departures - AIX Security-COK</h2>
        <table id="departures-table">
          <thead>
            <tr>
              <th>Flight No</th>
              <th>Registration</th>
              <th>To</th>
              <th>ETD</th>
              <th>STD</th>
              <th>Aircraft</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="7" class="loading-indicator">Loading departure data...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <!-- Skip Weather Section -->

  </div> <!-- end of .app-container -->

  <button id="installButton" class="install-button">Install App</button>

  <script>
    const API_BASE = "https://api.flightradar24.com/common/v1/airport.json";
    const AIRPORT_CODE = "COK";
    const LOCAL_DELAY_KEY = "delayedFlights";
    let earliestTimestamp = Math.floor(Date.now() / 1000);

    const getFlightEndpoint = (mode, timestamp) => {
      return `${API_BASE}?code=${AIRPORT_CODE}&plugin[]=schedule&plugin-setting[schedule][mode]=${mode}&plugin-setting[schedule][timestamp]=${timestamp}&limit=100&page=-1`;
    };

    const toLocalTime = (ts) =>
      ts ? new Date(ts * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }) : "-";

    const classifyStatus = (estimated, scheduled) => {
      if (!estimated || !scheduled) return "status-green";
      const delay = estimated - scheduled;
      if (delay <= 0) return "status-green";
      if (delay <= 900) return "status-orange";
      return "status-red";
    };

    const getLogoURL = (flightNumber) => {
      if (flightNumber.startsWith("IX")) return "https://cdn.brandfetch.io/idM6IAvrlf/w/820/h/248/theme/dark/logo.png";
      if (flightNumber.startsWith("AI")) return "https://cdn.brandfetch.io/id-PSmaCm4/w/800/h/284/theme/light/logo.png";
      if (flightNumber.startsWith("UL")) return "https://cdn.brandfetch.io/idZQkqhbVi/w/800/h/578/theme/dark/symbol.png";
      if (["AK", "FD"].some(code => flightNumber.startsWith(code))) return "https://upload.wikimedia.org/wikipedia/commons/thumb/8/82/AirAsia_New_Logo_%282020%29.svg/768px-AirAsia_New_Logo_%282020%29.svg.png";
      if (flightNumber.startsWith("FZ")) return "https://cdn.brandfetch.io/idzRsGDSFE/w/800/h/162/theme/dark/logo.png";
      if (flightNumber.startsWith("J9")) return "https://cdn.brandfetch.io/idRWbgTyu0/w/800/h/248/theme/dark/logo.png";
      return "";
    };

    const saveDelayedFlight = (flight, type) => {
      const key = `${type}-${flight.flight.identification.number.default}`;
      let saved = JSON.parse(localStorage.getItem(LOCAL_DELAY_KEY) || "{}");
      saved[key] = flight;
      localStorage.setItem(LOCAL_DELAY_KEY, JSON.stringify(saved));
    };

    const loadSavedDelayedFlights = (type) => {
      const saved = JSON.parse(localStorage.getItem(LOCAL_DELAY_KEY) || "{}");
      return Object.values(saved).filter(f => {
        const isDep = type === "departures";
        const act = isDep ? f.flight.time.actual?.departure : f.flight.time.actual?.arrival;
        return !act;
      });
    };

    const clearOldDelayedFlights = () => {
      const saved = JSON.parse(localStorage.getItem(LOCAL_DELAY_KEY) || "{}");
      const updated = {};
      for (const [key, f] of Object.entries(saved)) {
        const isDep = key.startsWith("departures-");
        const act = isDep ? f.flight.time.actual?.departure : f.flight.time.actual?.arrival;
        if (!act) updated[key] = f;
      }
      localStorage.setItem(LOCAL_DELAY_KEY, JSON.stringify(updated));
    };
    const appendFlightsToTable = (flights, type) => {
      const tbody = document.querySelector(`#${type}-table tbody`);
      const now = Math.floor(Date.now() / 1000);
      const existing = new Set();
      tbody.querySelectorAll("tr").forEach(row => {
        const fn = row.querySelector("td")?.innerText?.trim();
        if (fn) existing.add(fn);
      });

      flights.forEach(f => {
        const fl = f.flight;
        const isDep = type === "departures";
        const est = isDep ? fl.time.estimated?.departure : fl.time.estimated?.arrival;
        const sch = isDep ? fl.time.scheduled?.departure : fl.time.scheduled?.arrival;
        const act = isDep ? fl.time.actual?.departure : fl.time.actual?.arrival;
        const fn = fl.identification.number?.default || "-";
        const reg = fl.aircraft?.registration || "-";
        const airportCode = isDep ? fl.airport.destination?.code?.iata : fl.airport.origin?.code?.iata || "-";
        const model = fl.aircraft?.model?.text || "-";
        const status = fl.status?.text || "-";
        const logo = getLogoURL(fn);

        const isDelayed = sch && now > sch && !act && (!est || est > now);
        const isCompleted = act && act <= now;
        if (isDelayed) saveDelayedFlight(f, type);
        if (existing.has(fn)) return;

        const row = document.createElement("tr");
        if (isDelayed) row.classList.add("delayed-row");
        else if (isCompleted) row.classList.add("completed-row");

        row.innerHTML = `
          <td><img class="flight-logo" src="${logo}" alt="logo"> ${fn}</td>
          <td>${reg}</td>
          <td>${airportCode}</td>
          <td>${toLocalTime(est)}</td>
          <td>${toLocalTime(sch)}</td>
          <td>${model}</td>
          <td class="${classifyStatus(est, sch)}">${status}</td>
        `;
        tbody.appendChild(row);
      });
    };

    const loadFlights = async (type) => {
      try {
        const timestamp = Math.floor(Date.now() / 1000);
        const res = await fetch(getFlightEndpoint(type, timestamp));
        const data = await res.json();
        const all = data?.result?.response?.airport?.pluginData?.schedule?.[type]?.data || [];

        const savedDelayed = loadSavedDelayedFlights(type);
        all.push(...savedDelayed);

        const tbody = document.querySelector(`#${type}-table tbody`);
        tbody.innerHTML = "";
        appendFlightsToTable(all, type);

        document.getElementById("lastUpdated").textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
      } catch (e) {
        console.error(`Error loading ${type}:`, e);
      }
    };

    const loadEarlierFlights = async (type) => {
      earliestTimestamp -= 2 * 3600;
      try {
        const res = await fetch(getFlightEndpoint(type, earliestTimestamp));
        const data = await res.json();
        const more = data?.result?.response?.airport?.pluginData?.schedule?.[type]?.data || [];
        appendFlightsToTable(more, type);
      } catch (e) {
        console.error("Failed to load earlier flights", e);
      }
    };

    const refreshAllFlights = () => {
      const type = document.getElementById("flightTypeFilter").value;
      if (type === "all" || type === "arrivals") loadFlights("arrivals");
      if (type === "all" || type === "departures") loadFlights("departures");
    };
    // Theme Management
    const themeToggle = document.getElementById("themeToggle");
    const setTheme = (theme) => {
      document.documentElement.setAttribute("data-theme", theme);
      themeToggle.textContent = theme === "dark" ? "Toggle Light Mode" : "Toggle Dark Mode";
      localStorage.setItem("theme", theme);
    };

    const initializeTheme = () => {
      const savedTheme = localStorage.getItem("theme") || "light";
      setTheme(savedTheme);
    };

    // Tabs
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".content-section").forEach(s => s.classList.remove("active"));
        tab.classList.add("active");
        const name = tab.getAttribute("data-tab");
        document.getElementById(`${name}-section`).classList.add("active");
      });
    });

    // Event Listeners
    themeToggle.addEventListener("click", () => {
      const current = document.documentElement.getAttribute("data-theme") || "light";
      setTheme(current === "dark" ? "light" : "dark");
    });

    document.getElementById("airlineFilter").addEventListener("change", refreshAllFlights);
    document.getElementById("sortOption").addEventListener("change", refreshAllFlights);
    document.getElementById("timeWindow").addEventListener("change", refreshAllFlights);
    document.getElementById("flightTypeFilter").addEventListener("change", refreshAllFlights);
    document.getElementById("refreshButton").addEventListener("click", refreshAllFlights);
    document.getElementById("loadEarlierBtn").addEventListener("click", () => {
      const type = document.getElementById("flightTypeFilter").value;
      if (type === "arrivals" || type === "all") loadEarlierFlights("arrivals");
      if (type === "departures" || type === "all") loadEarlierFlights("departures");
    });

    // PWA Installation Support
    let deferredPrompt;
    const installButton = document.getElementById("installButton");

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installButton.style.display = 'block';
    });

    installButton.addEventListener('click', () => {
      installButton.style.display = 'none';
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(choice => {
        if (choice.outcome === 'accepted') {
          console.log("App installed");
        }
        deferredPrompt = null;
      });
    });

    // Start App
    initializeTheme();
    refreshAllFlights();
    setInterval(refreshAllFlights, 30000);
  </script>
</body>
</html>
