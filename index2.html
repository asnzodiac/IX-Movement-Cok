<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flight Tracker - COK</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 20px; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #333; color: white; }
    tr:nth-child(even) { background-color: #f2f2f2; }
    tr.delayed { background-color: #ffe0e0; }
    .controls { text-align: center; margin-bottom: 20px; }
    select { padding: 6px; margin: 0 10px; }
  </style>
</head>
<body>
  <h1>Live Flight Status - COK</h1>

  <div class="controls">
    <label for="airlineFilter">Filter:</label>
    <select id="airlineFilter" onchange="renderTables()">
      <option value="IX">IX Only</option>
      <option value="IXAI">IX + AI</option>
      <option value="ALL">All</option>
    </select>

    <label for="sortOption">Sort By:</label>
    <select id="sortOption" onchange="renderTables()">
      <option value="estimated">Estimated</option>
      <option value="scheduled">Scheduled</option>
    </select>
  </div>

  <h2>Arrivals</h2>
  <table id="arrivalsTable">
    <thead>
      <tr>
        <th>Flight</th>
        <th>Logo</th>
        <th>From</th>
        <th>STA</th>
        <th>ETA</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Departures</h2>
  <table id="departuresTable">
    <thead>
      <tr>
        <th>Flight</th>
        <th>Logo</th>
        <th>To</th>
        <th>STD</th>
        <th>ETD</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const fetchFlights = async () => {
      try {
        const res = await fetch('https://your-api-url.com/flights'); // Replace with actual API
        return await res.json();
      } catch (err) {
        console.error('Failed to fetch data:', err);
        return { arrivals: [], departures: [] };
      }
    };

    const formatTime = ts => {
      if (!ts) return "-";
      const d = new Date(ts * 1000);
      return d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
    };

    const getStatus = (sch, est) => {
      if (!est) return "Scheduled";
      if (est > sch) return "Delayed";
      return "On Time";
    };

    const getLogo = airlineCode => {
      return `<img src="https://content.airhex.com/content/logos/airlines_${airlineCode}_64.png" height="24" alt="${airlineCode}">`;
    };

    const filterAndSortFlights = (flights, type) => {
      const filterValue = document.getElementById("airlineFilter").value;
      const sortOption = document.getElementById("sortOption").value;
      const now = Math.floor(Date.now() / 1000);

      return flights.filter(f => {
        const fn = f.flight?.identification?.number?.default || "";
        const airlineCode = fn.substring(0, 2);
        const est = type === "departures" ? f.flight.time.estimated?.departure : f.flight.time.estimated?.arrival;
        const sch = type === "departures" ? f.flight.time.scheduled?.departure : f.flight.time.scheduled?.arrival;

        // Show if ETA/ETD or STA/STD is still in the future
        if ((sch && sch < now) && (est && est < now)) return false;

        if (filterValue === "IX") {
          return fn.startsWith("IX");
        } else if (filterValue === "IXAI") {
          return fn.startsWith("IX") || fn.startsWith("AI");
        } else {
          return fn.startsWith("IX") || ["AK", "FD", "UL", "FZ", "J9"].includes(airlineCode);
        }
      }).sort((a, b) => {
        const getTime = f => {
          return sortOption === "estimated"
            ? (type === "departures" ? f.flight.time.estimated?.departure : f.flight.time.estimated?.arrival) || 0
            : (type === "departures" ? f.flight.time.scheduled?.departure : f.flight.time.scheduled?.arrival) || 0;
        };
        return getTime(a) - getTime(b);
      });
    };

    const renderTable = (flights, type) => {
      const tableBody = document.getElementById(`${type}Table`).querySelector("tbody");
      tableBody.innerHTML = "";

      flights.forEach(f => {
        const fn = f.flight?.identification?.number?.default || "";
        const reg = f.flight?.aircraft?.registration || "";
        const origin = f.flight?.airport?.origin?.name || "-";
        const dest = f.flight?.airport?.destination?.name || "-";
        const airlineCode = fn.substring(0, 2);

        const sch = type === "departures" ? f.flight.time.scheduled?.departure : f.flight.time.scheduled?.arrival;
        const est = type === "departures" ? f.flight.time.estimated?.departure : f.flight.time.estimated?.arrival;

        const row = document.createElement("tr");
        if (est && sch && est > sch) row.classList.add("delayed");

        row.innerHTML = `
          <td>${fn} (${reg})</td>
          <td>${getLogo(airlineCode)}</td>
          <td>${type === "departures" ? dest : origin}</td>
          <td>${formatTime(sch)}</td>
          <td>${formatTime(est)}</td>
          <td>${getStatus(sch, est)}</td>
        `;
        tableBody.appendChild(row);
      });
    };

    const renderTables = async () => {
      const data = await fetchFlights();
      const arrivals = filterAndSortFlights(data.arrivals || [], "arrivals");
      const departures = filterAndSortFlights(data.departures || [], "departures");

      renderTable(arrivals, "arrivals");
      renderTable(departures, "departures");
    };

    renderTables();
    setInterval(renderTables, 60000); // Refresh every 60 sec
  </script>
</body>
</html>
