<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIX Flight Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #333; color: #fff; }
    td.highlight { background-color: #ffeeba; }
  </style>
</head>
<body>
  <h1>AIX Flight Tracker - COK</h1>
  <label>Show:
    <select id="flightMode">
      <option value="arrivals">Arrivals</option>
      <option value="departures">Departures</option>
    </select>
  </label>
  <table>
    <thead>
      <tr><th>Flight</th><th>From/To</th><th>ETA/STD</th><th>Status</th><th>Follow</th></tr>
    </thead>
    <tbody id="flightTable"><tr><td colspan="5">Loading...</td></tr>
    </tbody>
  </table>

  <script>
    const API_BASE = "https://kittu-0wb2.onrender.com";
    let followed = JSON.parse(localStorage.getItem("followed") || "[]");

    async function loadFlights() {
      const mode = document.getElementById("flightMode").value;
      const res = await fetch(\`\${API_BASE}/flights?mode=\${mode}\`);
      const flights = await res.json();

      const tbody = document.getElementById("flightTable");
      tbody.innerHTML = "";
      const now = Date.now() / 1000;

      flights.forEach(f => {
        const isFollowed = followed.includes(f.flight);
        const eta = new Date(f.eta * 1000).toLocaleTimeString();
        const shouldNotify = isFollowed && f.eta - now <= 900 && f.eta - now > 0;

        if (shouldNotify && Notification.permission === "granted") {
          navigator.serviceWorker.getRegistration().then(reg => {
            if (reg) {
              reg.showNotification("Followed Flight", {
                body: \`\${f.flight} ETA in \${Math.round((f.eta - now) / 60)} min\`,
                icon: "icon-192.png"
              });
            }
          });
        }

        const row = document.createElement("tr");
        if (shouldNotify) row.classList.add("highlight");
        row.innerHTML = \`
          <td>\${f.flight}</td>
          <td>\${f.from || f.to}</td>
          <td>\${eta}</td>
          <td>\${f.status}</td>
          <td><input type="checkbox" \${isFollowed ? "checked" : ""}
            onchange="toggleFollow('\${f.flight}', this.checked)"></td>
        \`;
        tbody.appendChild(row);
      });
    }

    function toggleFollow(flight, isChecked) {
      if (isChecked) followed.push(flight);
      else followed = followed.filter(f => f !== flight);
      localStorage.setItem("followed", JSON.stringify(followed));
    }

    document.getElementById("flightMode").addEventListener("change", loadFlights);
    if (Notification.permission !== "granted") Notification.requestPermission();
    setInterval(loadFlights, 30000);
    loadFlights();
  </script>
</body>
</html>