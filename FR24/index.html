<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-192.png" />
  <title>AIX SEC OPS</title>
  <style>
    body { font-family: Arial; margin: 20px; background: #fff; color: #000; transition: background-color 0.3s, color 0.3s;}
    body.dark { background: #121212; color: #ddd; }
    header { display: flex; justify-content: space-between; align-items: center; }
    .tabs { margin-top: 20px; }
    .tab { padding: 10px; cursor: pointer; display: inline-block; border: 1px solid #ccc; margin-right: 5px; border-radius: 4px;}
    .tab.active { background: #007bff; color: #fff; border-color: #007bff;}
    .tab-content { display: none; margin-top: 10px; }
    .tab-content.active { display: block; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f2f2f2; }
    body.dark th { background: #333; }
    .status-green { color: green; }
    .status-orange { color: orange; }
    .status-red { color: red; }
    button { cursor: pointer; padding: 6px 12px; margin-left: 10px; border-radius: 4px; border:none; background:#007bff; color:#fff; }
    button:hover { background:#0056b3; }
    select { padding: 4px; }
  </style>
</head>
<body>
  <header>
    <h1>AIX SEC OPS</h1>
    <div>
      <button onclick="location.href='admin.html'">Admin</button>
      <button id="themeToggle">Dark Mode</button>
    </div>
  </header>

  <label>Airline Filter:
    <select id="airlineFilter">
      <option value="all">All</option>
      <option value="IX">IX Only</option>
      <option value="IXAI">IX + AI</option>
    </select>
  </label>

  <div class="tabs">
    <div class="tab active" data-tab="arrivals">Arrivals</div>
    <div class="tab" data-tab="departures">Departures</div>
    <div class="tab" data-tab="turnaround">Turnaround</div>
  </div>

  <div id="arrivals" class="tab-content active">
    <table>
      <thead>
        <tr><th>Flight</th><th>From</th><th>ETA</th><th>STA</th><th>A/C Type</th><th>Reg</th><th>Status</th><th>Bay</th><th>Belt</th></tr>
      </thead>
      <tbody id="arrivals-table"><tr><td colspan="9">Loading...</td></tr></tbody>
    </table>
  </div>

  <div id="departures" class="tab-content">
    <table>
      <thead>
        <tr><th>Flight</th><th>To</th><th>ETD</th><th>STD</th><th>A/C Type</th><th>Reg</th><th>Status</th><th>Bay</th><th>Belt</th></tr>
      </thead>
      <tbody id="departures-table"><tr><td colspan="9">Loading...</td></tr></tbody>
    </table>
  </div>

  <div id="turnaround" class="tab-content">
    <table>
      <thead>
        <tr><th>Arr / Dep Flight</th><th>Reg</th><th>STA / STD</th><th>Sector</th><th>A/C Type</th><th>Status</th><th>Bay</th><th>Belt</th></tr>
      </thead>
      <tbody id="turnaround-table"><tr><td colspan="8">Loading...</td></tr></tbody>
    </table>
  </div>

  <script>
    const API_BASE = 'https://kittu-0wb2.onrender.com';
    const activeAirlines = ["IX", "AK", "FD", "FZ", "UL", "J9"];

    // Tabs logic
    document.querySelectorAll(".tab").forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.tab).classList.add("active");
      };
    });

    // Dark mode toggle
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.onclick = () => {
      document.body.classList.toggle('dark');
      themeToggle.textContent = document.body.classList.contains('dark') ? 'Light Mode' : 'Dark Mode';
      localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
    };
    // Load saved theme
    if(localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark');
      themeToggle.textContent = 'Light Mode';
    }

    function toTime(ts) {
      return ts ? new Date(ts * 1000).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', hour12: false}) : "-";
    }

    function filterFlight(flightNo) {
      const filter = document.getElementById('airlineFilter').value;
      if (filter === "IX") return flightNo.startsWith("IX");
      if (filter === "IXAI") return flightNo.startsWith("IX") || flightNo.startsWith("AI");
      return activeAirlines.includes(flightNo.slice(0, 2));
    }

    async function loadFlights(mode, tableId) {
      const res = await fetch(`${API_BASE}/flights?mode=${mode}`);
      const data = await res.json();
      const tbody = document.getElementById(tableId);
      tbody.innerHTML = "";

      data.filter(f => filterFlight(f.flight)).forEach(f => {
        const row = `<tr>
          <td>${f.flight}</td>
          <td>${mode === 'arrivals' ? f.from : f.to}</td>
          <td>${toTime(f.eta)}</td>
          <td>${toTime(f.std)}</td>
          <td>${f.model || '-'}</td>
          <td>${f.reg}</td>
          <td>${f.status}</td>
          <td>${f.bay || '-'}</td>
          <td>${f.belt || '-'}</td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    async function loadTurnaround() {
      const resArr = await fetch(`${API_BASE}/flights?mode=arrivals`);
      const resDep = await fetch(`${API_BASE}/flights?mode=departures`);
      const arr = await resArr.json();
      const dep = await resDep.json();
      const tbody = document.getElementById('turnaround-table');
      tbody.innerHTML = "";

      arr.forEach(a => {
        if(!filterFlight(a.flight)) return;
        // Find matching departure with same reg and departs within 2 hours of arrival std
        const match = dep.find(d => d.reg === a.reg && d.std > a.std && (d.std - a.std) <= 7200 && filterFlight(d.flight));
        if (!match) return;

        const row = `<tr>
          <td>${a.flight} / ${match.flight}</td>
          <td>${a.reg}</td>
          <td>${toTime(a.std)} / ${toTime(match.std)}</td>
          <td>${a.from} - COK - ${match.to}</td>
          <td>${a.model || '-'}</td>
          <td>${a.status}</td>
          <td>${a.bay || '-'}</td>
          <td>${a.belt || '-'}</td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    document.getElementById("airlineFilter").onchange = () => {
      loadFlights("arrivals", "arrivals-table");
      loadFlights("departures", "departures-table");
      loadTurnaround();
    };

    loadFlights("arrivals", "arrivals-table");
    loadFlights("departures", "departures-table");
    loadTurnaround();
    setInterval(() => {
      loadFlights("arrivals", "arrivals-table");
      loadFlights("departures", "departures-table");
      loadTurnaround();
    }, 30000);
  </script>
</body>
</html>
