
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIX Tracker</title>
  <style>
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { padding: 8px; border: 1px solid #ccc; text-align: left; }
    th { background: #eee; }
    button { padding: 6px 12px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>AIX Tracker</h1>

  <section>
    <h2>Arrivals</h2>
    <button onclick="loadEarlier('arrivals')">Load Earlier Arrivals</button>
    <table id="arrivals-table">
      <thead><tr><th>Flight</th><th>From</th><th>ETA</th><th>STA</th><th>Reg</th><th>Aircraft</th><th>Status</th></tr></thead>
      <tbody><tr><td colspan="7">Loading...</td></tr></tbody>
    </table>
  </section>

  <section>
    <h2>Departures</h2>
    <button onclick="loadEarlier('departures')">Load Earlier Departures</button>
    <table id="departures-table">
      <thead><tr><th>Flight</th><th>To</th><th>ETD</th><th>STD</th><th>ATD</th><th>Reg</th><th>Aircraft</th><th>Status</th></tr></thead>
      <tbody><tr><td colspan="8">Loading...</td></tr></tbody>
    </table>
  </section>

  <section>
    <h2>Turnaround</h2>
    <table id="turnaround-table">
      <thead><tr><th>Arr / Dep</th><th>Reg</th><th>STA / STD</th><th>Route</th><th>Aircraft</th><th>Status</th><th>ATD</th></tr></thead>
      <tbody><tr><td colspan="7">Loading...</td></tr></tbody>
    </table>
  </section>

  <script>
    const API_BASE = "/flights";
    const SERPAPI_KEY = "e68e2dff18aea3576dc576b2e3ef1bbdd403cf42d69a7b47a30f6c755effe412";
    let timestamps = {
      arrivals: Math.floor(Date.now() / 1000),
      departures: Math.floor(Date.now() / 1000)
    };

    const formatTime = ts => ts ? new Date(ts * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : "-";

    async function fetchATD(flightNo) {
      try {
        const res = await fetch(`/search-atd?flight=${flightNo}`);
        const data = await res.json();
        const snippet = data.results?.[0] || "";
        const match = snippet.match(/(\d{1,2}:\d{2})\s*(AM|PM)?/i);
        return match ? match[0] : "-";
      } catch {
        return "-";
      }
    }

    async function loadFlights(mode, append = false) {
      const ts = timestamps[mode];
      const res = await fetch(`${API_BASE}?mode=${mode}&ts=${ts}`);
      const data = await res.json();
      const tableId = `${mode}-table`;
      const tbody = document.getElementById(tableId).querySelector("tbody");
      if (!append) tbody.innerHTML = "";

      for (const f of data) {
        const tr = document.createElement("tr");
        if (mode === "arrivals") {
          tr.innerHTML = `
            <td>${f.flight}</td><td>${f.from}</td><td>${formatTime(f.eta)}</td>
            <td>${formatTime(f.std)}</td><td>${f.reg}</td><td>${f.model}</td><td>${f.status}</td>
          `;
        } else {
          const atdId = `atd-${f.flight}-${ts}`;
          tr.innerHTML = `
            <td>${f.flight}</td><td>${f.to}</td><td>${formatTime(f.eta)}</td>
            <td>${formatTime(f.std)}</td><td id="${atdId}">Loading...</td>
            <td>${f.reg}</td><td>${f.model}</td><td>${f.status}</td>
          `;
          fetchATD(f.flight).then(atd => {
            const el = document.getElementById(atdId);
            if (el) el.textContent = atd;
          });
        }
        tbody.appendChild(tr);
      }

      timestamps[mode] -= 7200; // subtract 2 hours for next load
    }

    async function loadTurnaround() {
      const arr = await fetch(`${API_BASE}?mode=arrivals`).then(res => res.json());
      const dep = await fetch(`${API_BASE}?mode=departures`).then(res => res.json());
      const tbody = document.getElementById("turnaround-table").querySelector("tbody");
      tbody.innerHTML = "";

      for (const a of arr) {
        const match = dep.find(d => d.reg === a.reg && d.std > a.std && d.std - a.std <= 7200);
        if (!match) continue;

        const atdId = `turn-atd-${match.flight}`;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${a.flight} / ${match.flight}</td><td>${a.reg}</td>
          <td>${formatTime(a.std)} / ${formatTime(match.std)}</td>
          <td>${a.from} - COK - ${match.to}</td><td>${a.model}</td>
          <td>${a.status} / ${match.status}</td><td id="${atdId}">Loading...</td>
        `;
        tbody.appendChild(tr);

        fetchATD(match.flight).then(atd => {
          const el = document.getElementById(atdId);
          if (el) el.textContent = atd;
        });
      }
    }

    function loadEarlier(mode) {
      loadFlights(mode, true);
    }

    loadFlights("arrivals");
    loadFlights("departures");
    loadTurnaround();
    setInterval(() => {
      loadFlights("arrivals");
      loadFlights("departures");
      loadTurnaround();
    }, 60000);
  </script>
</body>
</html>
